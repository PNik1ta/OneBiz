pipeline {
    agent any

    parameters {
        string(name: 'GIT_BRANCH', defaultValue: 'main', description: '–í–≤–µ–¥–∏—Ç–µ –≤–µ—Ç–∫—É –¥–ª—è –¥–µ–ø–ª–æ—è')
    }

    environment {
        DEPLOY_DIR = "/app"
    }

    stages {
        stage('Fix workspace permissions') {
            steps {
                sh 'sudo chown -R jenkins:jenkins /var/lib/jenkins/workspace/Back-prod-deployment || true'
                sh 'sudo chmod -R u+w /var/lib/jenkins/workspace/Back-prod-deployment || true'
            }
        }

        stage('Checkout Code') {
            steps {
                script {
                    echo "üì• –ö–ª–æ–Ω–∏—Ä—É–µ–º –∫–æ–¥ –∏–∑ –≤–µ—Ç–∫–∏: ${params.GIT_BRANCH}"
                    checkout([$class: 'GitSCM',
                        branches: [[name: "*/${params.GIT_BRANCH}"]],
                        userRemoteConfigs: [[
                            url: 'https://github.com/PNik1ta/OneBiz',
                            credentialsId: 'github-token'
                        ]]
                    ])
                }
            }
        }

		  stage('Copy .env') {
    			steps {
    			    script {
    			        sh 'cp /root/onebiz/backend/.env $WORKSPACE/.env'
    			    }
    			}
			}
        stage('Restart Containers') {
    			steps {
        			script {
            		echo "‚ôªÔ∏è –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
            		sh "docker-compose -f $WORKSPACE/docker-compose.yml down"
            		sh "docker-compose -f $WORKSPACE/docker-compose.yml up -d --build"
        			}
    			}
			}
    }

    post {
        success {
            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ!"
        }
        failure {
            echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–µ–ø–ª–æ–µ!"
        }
    }
}